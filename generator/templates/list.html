{% extends "base.html" %}
{% from "_partials/status_badge.html" import mini_status %}

{% block title %}{{ entity_type_display }} - CG Review{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="{{ base_url }}/">Home</a> &raquo;
    {{ entity_type_display }}
</nav>

<h1>{{ entity_type_display }}</h1>

{% if pages|length > 1 %}
<nav class="pagination">
    {% for page in pages %}
        {% if page.is_current %}
            <span class="page-current">{{ page.label }}</span>
        {% else %}
            <a href="{{ base_url }}{{ page.path }}">{{ page.label }}</a>
        {% endif %}
    {% endfor %}
</nav>
{% endif %}

<div class="list-stats">
    <span class="stat-valid">{{ counts.valid }} valid</span>
    <span class="stat-invalid">{{ counts.invalid }} invalid</span>
    <span class="stat-blocked">{{ counts.blocked }} blocked</span>
    <span class="stat-unknown">{{ counts.unknown }} pending</span>
    <span class="stat-total">({{ counts.total }} total)</span>
</div>

<div class="list-filters">
    <label>
        <input type="checkbox" id="filter-valid" checked> Show valid
    </label>
    <label>
        <input type="checkbox" id="filter-invalid" checked> Show invalid
    </label>
    <label>
        <input type="checkbox" id="filter-blocked" checked> Show blocked
    </label>
    <label>
        <input type="checkbox" id="filter-unknown" checked> Show pending
    </label>
</div>

<table class="entity-table list-table" id="entity-list">
    <thead>
        <tr>
            <th>Status</th>
            <th>ID</th>
            {% if group_field %}
            <th>{{ group_field_label }}</th>
            {% endif %}
            <th>{{ primary_field_label }}</th>
            {% if secondary_field_label %}
            <th>{{ secondary_field_label }}</th>
            {% endif %}
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for entity in entities %}
        {% set status = entity|get_status %}
        <tr class="row-{{ status }}" data-status="{{ status }}">
            <td>{{ mini_status(entity) }}</td>
            <td>{{ entity.id }}</td>
            {% if group_field %}
            <td>{{ entity[group_field] }}</td>
            {% endif %}
            <td>
                {% if primary_field == 'excerpt' %}
                {{ (entity[primary_field][:80] ~ '...' if entity[primary_field]|length > 80 else entity[primary_field]) }}
                {% else %}
                {{ entity[primary_field] or '-' }}
                {% endif %}
            </td>
            {% if secondary_field %}
            <td>{{ entity[secondary_field] or '-' }}</td>
            {% endif %}
            <td><a href="{{ base_url }}/{{ entity_type }}/{{ entity.id }}/">View</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if pages|length > 1 %}
<nav class="pagination">
    {% for page in pages %}
        {% if page.is_current %}
            <span class="page-current">{{ page.label }}</span>
        {% else %}
            <a href="{{ base_url }}{{ page.path }}">{{ page.label }}</a>
        {% endif %}
    {% endfor %}
</nav>
{% endif %}

<script>
// Client-side filtering with localStorage persistence
const FILTER_KEY = 'cg-review-filters';

function getFilters() {
    try {
        const stored = localStorage.getItem(FILTER_KEY);
        return stored ? JSON.parse(stored) : null;
    } catch (e) { return null; }
}

function saveFilters() {
    const state = {};
    document.querySelectorAll('.list-filters input').forEach(cb => {
        state[cb.id.replace('filter-', '')] = cb.checked;
    });
    try { localStorage.setItem(FILTER_KEY, JSON.stringify(state)); } catch (e) {}
}

function applyFilters() {
    document.querySelectorAll('.list-filters input').forEach(cb => {
        const status = cb.id.replace('filter-', '');
        document.querySelectorAll(`tr[data-status="${status}"]`).forEach(row => {
            row.style.display = cb.checked ? '' : 'none';
        });
    });
}

// Restore saved state
const saved = getFilters();
if (saved) {
    document.querySelectorAll('.list-filters input').forEach(cb => {
        const status = cb.id.replace('filter-', '');
        if (status in saved) cb.checked = saved[status];
    });
}
applyFilters();

// Listen for changes
document.querySelectorAll('.list-filters input').forEach(cb => {
    cb.addEventListener('change', function() {
        saveFilters();
        applyFilters();
    });
});
</script>
{% endblock %}
