{% extends "base.html" %}
{% from "_partials/status_badge.html" import status_badge, mini_status %}
{% from "_partials/record_link.html" import record_link, simple_link %}
{% from "_partials/action_buttons.html" import action_buttons %}

{% block title %}Event Match {{ entity.id }} - CG Review{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="{{ base_url }}/">Home</a> &raquo;
    <a href="{{ base_url }}/eventmatch/">Event Matches</a> &raquo;
    Event Match {{ entity.id }}
</nav>

<div class="entity-header">
    <h1>Event Match #{{ entity.id }}</h1>
    {% if entity.accepted is none %}
    <span class="status-badge unknown">Pending</span>
    {% elif entity.accepted %}
    <span class="status-badge valid">Accepted</span>
    {% else %}
    <span class="status-badge invalid">Rejected</span>
    {% endif %}
</div>

<section class="entity-details">
    <h2>Match Details</h2>

    <dl class="detail-list">
        <dt>Source Event</dt>
        <dd>{{ simple_link('event', entity.event_id, 'Event #' ~ entity.event_id) }}</dd>

        <dt>Authoritative Event</dt>
        <dd>{{ simple_link('authoritativeevent', entity.authoritative_event_id, 'Auth. Event #' ~ entity.authoritative_event_id) }}</dd>

        <dt>Algorithm</dt>
        <dd><code>{{ entity.algorithm }}</code></dd>

        <dt>Rank</dt>
        <dd>{{ entity.rank + 1 }}</dd>

        <dt>Date</dt>
        <dd>{{ entity.date_added }}</dd>
    </dl>
</section>

<section class="entity-details">
    <h2>Dimension Scores</h2>

    <table class="entity-table">
        <thead>
            <tr>
                <th>Dimension</th>
                <th>Score</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Location</td>
                <td>{{ '%.2f'|format(entity.location_score) if entity.location_score is not none else '-' }}</td>
                <td>
                    {% if entity.location_score is none %}
                    <span class="pending">Missing</span>
                    {% elif entity.location_score >= 0.7 %}
                    <span class="accepted-badge">Above threshold</span>
                    {% else %}
                    <span class="rejected-badge">Below threshold</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Time</td>
                <td>{{ '%.2f'|format(entity.time_score) if entity.time_score is not none else '-' }}</td>
                <td>
                    {% if entity.time_score is none %}
                    <span class="pending">Missing</span>
                    {% elif entity.time_score >= 0.7 %}
                    <span class="accepted-badge">Above threshold</span>
                    {% else %}
                    <span class="rejected-badge">Below threshold</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Actor</td>
                <td>{{ '%.2f'|format(entity.actor_score) if entity.actor_score is not none else '-' }}</td>
                <td>
                    {% if entity.actor_score is none %}
                    <span class="pending">Missing</span>
                    {% elif entity.actor_score >= 0.7 %}
                    <span class="accepted-badge">Above threshold</span>
                    {% else %}
                    <span class="rejected-badge">Below threshold</span>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>

    <dl class="detail-list">
        <dt>Composite Score</dt>
        <dd><strong>{{ '%.2f'|format(entity.composite_score) }}</strong></dd>

        <dt>Dimensions Matched</dt>
        <dd>{{ entity.dimensions_matched }}/3</dd>
    </dl>
</section>

<section class="entity-details">
    <h2>Resolution</h2>

    <dl class="detail-list">
        <dt>Accepted</dt>
        <dd>
            {% if entity.accepted is none %}
            <span class="pending">Pending</span>
            {% elif entity.accepted %}
            <span class="accepted-badge">Yes</span>
            {% else %}
            <span class="rejected-badge">No</span>
            {% endif %}
        </dd>

        {% if entity.accepted_reason %}
        <dt>Reason</dt>
        <dd>{{ entity.accepted_reason }}</dd>
        {% endif %}
    </dl>
</section>

{% if event %}
<section class="related-entities">
    <h2>Source Event</h2>
    <dl class="detail-list">
        <dt>Excerpt</dt>
        <dd class="excerpt">{{ event.excerpt }}</dd>
        {% if event.consolidation_status %}
        <dt>Consolidation Status</dt>
        <dd>{{ event.consolidation_status }}</dd>
        {% endif %}
    </dl>
</section>
{% endif %}

{% if auth_event %}
<section class="related-entities">
    <h2>Authoritative Event</h2>
    <dl class="detail-list">
        {% if auth_event.canonical_name %}
        <dt>Name</dt>
        <dd>{{ auth_event.canonical_name }}</dd>
        {% endif %}
        {% if auth_event.category %}
        <dt>Category</dt>
        <dd>{{ auth_event.category }}</dd>
        {% endif %}
        <dt>Source Events</dt>
        <dd>{{ auth_event.source_event_count }}</dd>
    </dl>
</section>
{% endif %}

{{ action_buttons('eventmatch', entity.id, {
    'Event': entity.event_id|string,
    'Auth Event': entity.authoritative_event_id|string,
    'Composite Score': entity.composite_score|string,
    'Accepted': entity.accepted|string if entity.accepted is not none else 'Pending'
}) }}
{% endblock %}
